# Инструкция по тестированию криптоплатежей

Это руководство поможет вам протестировать функционал покупки токенов за криптовалюту (ETH, USDT, WBTC).

## Способ 1: Тестирование на Sepolia Testnet (Рекомендуется)

### Шаг 1: Настройка MetaMask

1. Установите [MetaMask](https://metamask.io/) расширение в браузере
2. Создайте или импортируйте кошелек
3. Переключитесь на **Sepolia Testnet**:
   - Нажмите на название сети в верхней части MetaMask
   - Выберите "Sepolia test network" (если её нет, добавьте через "Add network")
   - Или используйте эти параметры:
     - Network Name: Sepolia
     - RPC URL: https://sepolia.infura.io/v3/YOUR_INFURA_KEY (или https://rpc.sepolia.org)
     - Chain ID: 11155111
     - Currency Symbol: ETH
     - Block Explorer: https://sepolia.etherscan.io

### Шаг 2: Получение тестовых ETH

1. Используйте один из Sepolia faucets:
   - [Alchemy Sepolia Faucet](https://sepoliafaucet.com/)
   - [Infura Sepolia Faucet](https://www.infura.io/faucet/sepolia)
   - [PoW Faucet](https://sepolia-faucet.pk910.de/)
   
2. Введите ваш адрес кошелька и запросите тестовые ETH

### Шаг 3: Настройка проекта

1. Создайте файл `.env.local` в папке `frontend/`:

```env
# Адрес казначейства для приема платежей (используйте ваш тестовый адрес)
NEXT_PUBLIC_TREASURY_ADDRESS=0xYourTestTreasuryAddress

# Адреса контрактов USDT и WBTC для Sepolia (можно оставить пустыми для тестирования только ETH)
# Для Sepolia можно использовать тестовые контракты или оставить пустыми
NEXT_PUBLIC_USDT_ADDRESS=
NEXT_PUBLIC_WBTC_ADDRESS=
```

**Примечание:** Для простого тестирования можете использовать любой адрес (например, адрес вашего тестового кошелька) как `NEXT_PUBLIC_TREASURY_ADDRESS`.

### Шаг 4: Запуск приложения

1. Откройте терминал и перейдите в папку проекта:
```bash
cd frontend
```

2. Запустите dev server:
```bash
npm run dev
```

3. Откройте браузер и перейдите на: `http://localhost:3000`

### Шаг 5: Тестирование покупки ETH

1. Перейдите на страницу покупки токенов (например, `/buy-tokens`)
2. Подключите MetaMask:
   - Нажмите кнопку подключения кошелька
   - Подтвердите подключение в MetaMask
3. Выберите метод оплаты "Cryptocurrency"
4. Выберите "ETH" в качестве криптовалюты
5. Введите сумму в EUR (например, 10)
6. Нажмите "Buy $TAI Tokens"
7. В MetaMask:
   - Проверьте детали транзакции
   - Подтвердите транзакцию
8. Дождитесь подтверждения транзакции
9. Проверьте, что появилось сообщение об успехе со ссылкой на Etherscan

### Шаг 6: Проверка результатов

- ✅ Транзакция отправлена успешно
- ✅ Появилось сообщение об успехе
- ✅ Есть ссылка на Etherscan для просмотра транзакции
- ✅ Транзакция сохранена в истории (если есть профиль пользователя)

---

## Способ 2: Тестирование на локальной Hardhat сети

Этот способ позволяет тестировать без затрат и быстрее, но требует настройки локальной сети.

### Шаг 1: Запуск локальной Hardhat сети

1. В одном терминале запустите:
```bash
npx hardhat node
```

Это запустит локальную Ethereum сеть на `http://localhost:8545` с тестовыми аккаунтами и балансами.

### Шаг 2: Импорт аккаунта в MetaMask

1. Скопируйте один из приватных ключей из вывода `hardhat node`
2. В MetaMask:
   - Нажмите на иконку аккаунта → "Import account"
   - Вставьте приватный ключ
   - Аккаунт будет иметь баланс 10000 ETH

3. Добавьте локальную сеть в MetaMask:
   - Network Name: Hardhat Local
   - RPC URL: http://localhost:8545
   - Chain ID: 1337
   - Currency Symbol: ETH

### Шаг 3: Настройка проекта

В `frontend/.env.local`:
```env
NEXT_PUBLIC_TREASURY_ADDRESS=0xYourTreasuryAddress
# Для локальной сети адреса USDT/WBTC не нужны (можно оставить пустыми)
```

**Совет:** Используйте один из тестовых адресов из Hardhat node как адрес казначейства.

### Шаг 4: Запуск и тестирование

Следуйте шагам 4-6 из "Способа 1", но используйте локальную сеть Hardhat.

---

## Тестирование USDT и WBTC

### Важно:

На **Sepolia testnet** нет официальных контрактов USDT и WBTC. Для полного тестирования этих токенов есть несколько вариантов:

### Вариант 1: Использовать Mainnet (только для демонстрации)

⚠️ **ВНИМАНИЕ:** Не используйте реальные средства для тестирования!

1. Переключите MetaMask на Ethereum Mainnet
2. Используйте адреса mainnet контрактов (они уже указаны в коде по умолчанию):
   - USDT: `0xdAC17F958D2ee523a2206206994597C13D831ec7`
   - WBTC: `0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599`

### Вариант 2: Деплой тестовых токенов (для разработки)

1. Создайте простой ERC-20 контракт
2. Задеплойте его на Sepolia или локальную сеть
3. Замените адреса в `.env.local`

### Вариант 3: Тестировать только ETH

Это самый простой способ для начального тестирования. Функционал ETH полностью идентичен USDT/WBTC, поэтому если ETH работает, то и токены будут работать.

---

## Проверка ошибок и отладка

### Консоль браузера (F12)

Проверьте консоль на наличие ошибок:
- Ошибки подключения к MetaMask
- Ошибки получения курсов криптовалют
- Ошибки отправки транзакций

### Network tab

Проверьте запросы к CoinGecko API для получения курсов криптовалют.

### MetaMask

- Проверьте, что выбрана правильная сеть
- Проверьте баланс кошелька
- Проверьте логи транзакций

---

## Типичные проблемы и решения

### Проблема: "Treasury address not configured"

**Решение:** Убедитесь, что в `.env.local` указан `NEXT_PUBLIC_TREASURY_ADDRESS`

### Проблема: "Failed to fetch ETH price"

**Решение:** 
- Проверьте интернет-соединение
- CoinGecko API может быть временно недоступен
- Попробуйте позже

### Проблема: "Insufficient balance"

**Решение:** 
- Убедитесь, что у вас достаточно ETH на балансе
- Учитывайте комиссию газа (gas fee)

### Проблема: "User rejected the request"

**Решение:** Это нормально - пользователь отменил транзакцию в MetaMask

### Проблема: Транзакция зависла

**Решение:**
- Проверьте настройки газа в MetaMask
- Увеличьте gas limit, если нужно
- Проверьте статус транзакции на Etherscan

---

## Что проверять при тестировании

✅ **Основной функционал:**
- [ ] Подключение кошелька работает
- [ ] Выбор метода оплаты (card/crypto) работает
- [ ] Выбор криптовалюты (ETH/USDT/WBTC) работает
- [ ] Ввод суммы работает
- [ ] Расчет суммы в криптовалюте корректный
- [ ] Проверка минимальной суммы работает

✅ **Покупка ETH:**
- [ ] Получение курса ETH/EUR работает
- [ ] Проверка баланса работает
- [ ] Отправка транзакции ETH работает
- [ ] Ожидание подтверждения работает
- [ ] Сообщение об успехе показывается
- [ ] Ссылка на Etherscan работает

✅ **Покупка USDT/WBTC (если настроено):**
- [ ] Получение курса токена работает
- [ ] Проверка баланса токена работает
- [ ] Approve транзакция работает (для токенов)
- [ ] Transfer транзакция работает
- [ ] Ожидание подтверждения работает

✅ **Обработка ошибок:**
- [ ] Ошибка недостаточного баланса показывается корректно
- [ ] Ошибка отмены транзакции обрабатывается
- [ ] Ошибка сети обрабатывается
- [ ] Ошибка получения курса обрабатывается

✅ **UI/UX:**
- [ ] Индикатор загрузки показывается во время обработки
- [ ] Сообщения об ошибках понятны
- [ ] Ссылка на Etherscan отображается корректно
- [ ] Поле суммы очищается после успешной покупки

---

## Примеры тестовых сценариев

### Сценарий 1: Успешная покупка за ETH

1. Подключить кошелек
2. Выбрать "Cryptocurrency" → "ETH"
3. Ввести сумму: 10 EUR
4. Нажать "Buy $TAI Tokens"
5. Подтвердить транзакцию в MetaMask
6. **Ожидаемый результат:** Успешное сообщение, ссылка на Etherscan

### Сценарий 2: Недостаточный баланс

1. Подключить кошелек с малым балансом
2. Выбрать "Cryptocurrency" → "ETH"
3. Ввести сумму: 1000 EUR (больше баланса)
4. Нажать "Buy $TAI Tokens"
5. **Ожидаемый результат:** Ошибка "Insufficient balance"

### Сценарий 3: Отмена транзакции

1. Подключить кошелек
2. Выбрать "Cryptocurrency" → "ETH"
3. Ввести сумму: 10 EUR
4. Нажать "Buy $TAI Tokens"
5. Отменить транзакцию в MetaMask
6. **Ожидаемый результат:** Ошибка "User rejected the request"

### Сценарий 4: Минимальная сумма

1. Подключить кошелек
2. Выбрать "Cryptocurrency" → "ETH"
3. Ввести сумму: 5 EUR (меньше минимума)
4. Нажать "Buy $TAI Tokens"
5. **Ожидаемый результат:** Кнопка неактивна или ошибка "Minimum purchase is €10"

---

## Полезные ссылки

- [Sepolia Etherscan](https://sepolia.etherscan.io/) - просмотр транзакций на Sepolia
- [MetaMask Docs](https://docs.metamask.io/) - документация MetaMask
- [Ethers.js Docs](https://docs.ethers.org/) - документация Ethers.js
- [CoinGecko API](https://www.coingecko.com/en/api) - API для курсов криптовалют

