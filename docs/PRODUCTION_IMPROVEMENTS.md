# –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è Production

–í–µ—Ä—Å–∏—è `LotteryV2.sol` –≤–∫–ª—é—á–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

## üéØ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Emergency Pause (–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ —Å–ª—É—á–∞–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –∞—Ç–∞–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º pause/unpause —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenZeppelin `Pausable`.

```solidity
function pause() external onlyOwner;    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
function unpause() external onlyOwner;  // –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º `whenNotPaused` –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ pause
- –ü–æ–∫—É–ø–∫–∞ –±–∏–ª–µ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
- Owner –º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏

---

### 2. –¢–∞–π–º–∞—É—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∑–∞—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—Å—Ç—Ä–µ–≤–∞—é—Ç –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–≤–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤:

#### 2.1 –¢–∞–π–º–∞—É—Ç –ª–æ—Ç–µ—Ä–µ–∏ (`maxLotteryDuration`)
- –õ–æ—Ç–µ—Ä–µ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
- –ò–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å —Å–≤–æ–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ `refundMyTickets()`

#### 2.2 –¢–∞–π–º–∞—É—Ç –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (`maxSelectionDuration`)
- –ï—Å–ª–∏ VRF callback –Ω–µ –ø—Ä–∏—à–µ–ª –≤–æ–≤—Ä–µ–º—è, —Å—Ä–µ–¥—Å—Ç–≤–∞ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Chainlink VRF

**–§—É–Ω–∫—Ü–∏–∏:**
```solidity
function refundMyTickets() external; // –ò–≥—Ä–æ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞
function emergencyRefundAll() external onlyOwner; // Owner –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
```

---

### 3. –ö–æ–º–∏—Å—Å–∏—è –¥–ª—è Owner

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø–æ–∫—Ä—ã—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (VRF subscription, gas, –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ).

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∫–æ–º–∏—Å—Å–∏—è.

```solidity
uint256 public ownerCommissionPercent; // –í basis points (100 = 1%)
address public commissionRecipient;    // –ê–¥—Ä–µ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–æ–º–∏—Å—Å–∏—è –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –ø—Ä–∏–∑–æ–≤–æ–≥–æ —Ñ–æ–Ω–¥–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–ª–∞—Ç–æ–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è: 10% (1000 basis points)
- –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ `setCommission()`
- –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏

**–ü—Ä–∏–º–µ—Ä:**
- –ü—Ä–∏–∑–æ–≤–æ–π —Ñ–æ–Ω–¥: 1 ETH
- –ö–æ–º–∏—Å—Å–∏—è: 2% (200 basis points)
- –ü–æ–±–µ–¥–∏—Ç–µ–ª—é: 0.98 ETH
- Owner: 0.02 ETH

---

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–£–ª—É—á—à–µ–Ω–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π –±–∏–ª–µ—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤
- –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (events)

**–ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è:**
- `FundsRefunded` - –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –∏–≥—Ä–æ–∫—É
- `EmergencyRefund` - —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –≤—Å–µ—Ö —Å—Ä–µ–¥—Å—Ç–≤
- `CommissionUpdated` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏

---

### 5. –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ª–æ—Ç–µ—Ä–µ–∏

–§—É–Ω–∫—Ü–∏—è `getLotteryStatus()` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
- `timeRemaining` - –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –ª–æ—Ç–µ—Ä–µ–∏
- `canRefund` - –º–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞
- –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π

| –§—É–Ω–∫—Ü–∏—è | Lottery.sol | LotteryV2.sol |
|---------|-------------|---------------|
| Chainlink VRF | ‚úÖ | ‚úÖ |
| ReentrancyGuard | ‚úÖ | ‚úÖ |
| Emergency Pause | ‚ùå | ‚úÖ |
| –¢–∞–π–º–∞—É—Ç—ã | ‚ùå | ‚úÖ |
| –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ | ‚ùå | ‚úÖ |
| –ö–æ–º–∏—Å—Å–∏—è | ‚ùå | ‚úÖ |
| Ownable | ‚ùå | ‚úÖ (OpenZeppelin) |
| Pausable | ‚ùå | ‚úÖ (OpenZeppelin) |
| –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å | ‚ùå | ‚úÖ |

---

## üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ LotteryV2

```solidity
constructor(
    uint256 _ticketPrice,              // –¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞
    uint256 _maxTickets,               // –ú–∞–∫—Å–∏–º—É–º –±–∏–ª–µ—Ç–æ–≤
    address vrfCoordinatorV2,          // VRF Coordinator –∞–¥—Ä–µ—Å
    bytes32 keyHash,                   // VRF Key Hash
    uint64 subscriptionId,             // Chainlink Subscription ID
    uint32 callbackGasLimit,           // Gas limit –¥–ª—è callback
    uint256 _maxLotteryDuration,       // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ª–æ—Ç–µ—Ä–µ–∏ (—Å–µ–∫—É–Ω–¥—ã)
    uint256 _maxSelectionDuration,     // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ (—Å–µ–∫—É–Ω–¥—ã)
    uint256 _ownerCommissionPercent    // –ö–æ–º–∏—Å—Å–∏—è –≤ basis points (100 = 1%)
)
```

**–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏–π:**
- `_maxLotteryDuration`: 7 –¥–Ω–µ–π = 604800 —Å–µ–∫—É–Ω–¥
- `_maxSelectionDuration`: 1 —á–∞—Å = 3600 —Å–µ–∫—É–Ω–¥
- `_ownerCommissionPercent`: 200 = 2%

---

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è —Å Lottery.sol –Ω–∞ LotteryV2.sol

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. **–î–µ–ø–ª–æ–π –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞** —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ VRF
2. **–ü–µ—Ä–µ–Ω–æ—Å subscription** - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∫–∞–∫ consumer
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ frontend** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ ABI
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:

‚ùå **–ù–ï–¢** - —ç—Ç–æ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç, –Ω–µ upgrade —Å—Ç–∞—Ä–æ–≥–æ. –ù—É–∂–µ–Ω –Ω–æ–≤—ã–π –¥–µ–ø–ª–æ–π.

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –¢–∞–π–º–∞—É—Ç—ã

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞–∑—É–º–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–≤
- `maxSelectionDuration` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –¥–ª—è Chainlink VRF (–æ–±—ã—á–Ω–æ 1-2 —á–∞—Å–∞)
- `maxLotteryDuration` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∂–µ–ª–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ—Ç–µ—Ä–µ–∏

### –ö–æ–º–∏—Å—Å–∏—è

- –ö–æ–º–∏—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 1-3% –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤
- –ú–∞–∫—Å–∏–º—É–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 10% –¥–ª—è –∑–∞—â–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### Emergency Pause

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
- Pause –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–∫—É–ø–∫—É –±–∏–ª–µ—Ç–æ–≤, –Ω–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
- Unpause –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã

---

## üìù –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ—Ç–µ—Ä–µ–∏

```javascript
const lottery = await LotteryV2.deploy(
    ethers.parseEther("0.01"),        // 0.01 ETH –∑–∞ –±–∏–ª–µ—Ç
    100,                               // 100 –±–∏–ª–µ—Ç–æ–≤ –º–∞–∫—Å–∏–º—É–º
    vrfCoordinator,                    // VRF –∞–¥—Ä–µ—Å
    keyHash,                           // Key hash
    subscriptionId,                    // Subscription ID
    500000,                            // Gas limit
    604800,                            // 7 –¥–Ω–µ–π
    3600,                              // 1 —á–∞—Å
    200                                // 2% –∫–æ–º–∏—Å—Å–∏—è
);
```

### –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –∏–≥—Ä–æ–∫–æ–º

```javascript
// –ï—Å–ª–∏ –ª–æ—Ç–µ—Ä–µ—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ –≤—ã–±–æ—Ä –∑–∞—Ç—è–Ω—É–ª—Å—è
await lottery.refundMyTickets();
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏

```javascript
await lottery.setCommission(300, ownerAddress); // 3% –∫–æ–º–∏—Å—Å–∏—è
```

### Emergency pause

```javascript
await lottery.pause();   // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
await lottery.unpause(); // –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å
```

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ testnet** –ø–µ—Ä–µ–¥ mainnet –¥–µ–ø–ª–æ–µ–º
2. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∑–∞ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ —Å–æ–±—ã—Ç–∏—è–º–∏
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—É–ª—å—Ç–∏—Å–∏–≥** –¥–ª—è owner —Ñ—É–Ω–∫—Ü–∏–π –≤ production
4. **–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∞—É–¥–∏—Ç** –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ** –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

