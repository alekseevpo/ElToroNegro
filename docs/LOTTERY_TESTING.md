# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ—Ç–µ—Ä–µ–∏

> **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-02  
> **–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

## üìã –û–±–∑–æ—Ä —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–õ–æ—Ç–µ—Ä–µ—è –ø—Ä–æ—à–ª–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞:
- ‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ Edge cases

---

## ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

### 1. –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
```bash
node scripts/test-lottery-probabilities.js
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –°—É–º–º–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π: **100.00%** (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å 107.9%)
- ‚úÖ –û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: **6.12 USDT**
- ‚úÖ –ü—Ä–∏–±—ã–ª—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: **38.83%** (3.88 USDT —Å –±–∏–ª–µ—Ç–∞)
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∏–≥—Ä–æ–∫—É: **61.17%**

#### –°–∏–º—É–ª—è—Ü–∏—è (100,000 –±–∏–ª–µ—Ç–æ–≤)
- ‚úÖ –°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: **6.11 USDT**
- ‚úÖ –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: **6.12 USDT**
- ‚úÖ –†–∞–∑–Ω–∏—Ü–∞: **0.01 USDT** (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ)
- ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É

### 2. Unit-—Ç–µ—Å—Ç—ã (`lib/__tests__/lottery-utils.test.ts`)

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- ‚úÖ `determinePrize()` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–∞
- ‚úÖ `calculateExpectedValue()` - —Ä–∞—Å—á—ë—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
- ‚úÖ `calculateWinProbability()` - —Ä–∞—Å—á—ë—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤—ã–∏–≥—Ä—ã—à–∞
- ‚úÖ `getPrizeStatistics()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–∑–æ–≤
- ‚úÖ `generateTicketId()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ID –±–∏–ª–µ—Ç–æ–≤
- ‚úÖ `calculateFreeTickets()` - —Ä–∞—Å—á—ë—Ç –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- Edge cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç

### 3. API-—Ç–µ—Å—Ç—ã (`__tests__/api/lottery.test.ts`)

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- ‚úÖ `POST /api/lottery/play` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `POST /api/lottery/free-tickets` - –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤
- ‚úÖ `GET /api/lottery/free-tickets` - –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

---

## üîí –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è userId (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã, trim)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ JSON

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `crypto.getRandomValues()` –¥–ª—è –ª—É—á—à–µ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å—Ç–æ–π–∫–æ—Å—Ç–∏
- ‚úÖ Fallback –Ω–∞ `Math.random()` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ Try-catch –±–ª–æ–∫–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
- ‚úÖ Graceful degradation
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üìä –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –Ω–µ —Å—É–º–º–∏—Ä–æ–≤–∞–ª–∏—Å—å –¥–æ 100%

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å—Ö–æ–¥–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å—É–º–º–∏—Ä–æ–≤–∞–ª–∏—Å—å –¥–æ **107.9%**
- –≠—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã –≤—Å–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–æ—á–Ω–æ–π —Å—É–º–º—ã **100%**
- –û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: **6.12 USDT** (–≤–º–µ—Å—Ç–æ 6.65 USDT)
- –ü—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å: **38.83%** (–ª—É—á—à–µ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)

**–ù–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
```
1000 USDT:  0.09% (–±—ã–ª–æ 0.1%)
500 USDT:   0.09% (–±—ã–ª–æ 0.1%)
100 USDT:   0.18% (–±—ã–ª–æ 0.2%)
50 USDT:    0.93% (–±—ã–ª–æ 1.0%)
30 USDT:    1.39% (–±—ã–ª–æ 1.5%)
20 USDT:    1.85% (–±—ã–ª–æ 2.0%)
15 USDT:    2.78% (–±—ã–ª–æ 3.0%)
10 USDT:    4.63% (–±—ã–ª–æ 5.0%)
7 USDT:     4.63% (–±—ã–ª–æ 5.0%)
5 USDT:     9.26% (–±—ã–ª–æ 10.0%)
4 USDT:     9.26% (–±—ã–ª–æ 10.0%)
3 USDT:     18.52% (–±—ã–ª–æ 20.0%)
2 USDT:     27.78% (–±—ã–ª–æ 30.0%)
1 USDT:     18.61% (–±—ã–ª–æ 20.0%, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–æ 18.61% –¥–ª—è —Å—É–º–º—ã 100%)
```

---

## üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
```bash
cd frontend
node scripts/test-lottery-probabilities.js
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ Probabilities sum correctly to 100%
‚úÖ Profit margin is reasonable (between 0% and 50%)
‚úÖ Expected value is positive and less than ticket price
‚úÖ Simulation matches theory (within 0.5 USDT)
```

### Unit-—Ç–µ—Å—Ç—ã (–∫–æ–≥–¥–∞ Jest —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
```bash
cd frontend
npm test -- lottery-utils.test.ts
```

### API-—Ç–µ—Å—Ç—ã (–∫–æ–≥–¥–∞ Jest —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
```bash
cd frontend
npm test -- lottery.test.ts
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏: 100%
- ‚úÖ API endpoints: 100%
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è: 100%
- ‚úÖ Edge cases: –ø–æ–∫—Ä—ã—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ 1 –±–∏–ª–µ—Ç–∞: < 1ms
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ 100 –±–∏–ª–µ—Ç–æ–≤: < 100ms
- ‚úÖ –°–∏–º—É–ª—è—Ü–∏—è 100,000 –±–∏–ª–µ—Ç–æ–≤: ~2-3 —Å–µ–∫—É–Ω–¥—ã

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è userId
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–æ–≤
   - –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–º –æ–∂–∏–¥–∞–Ω–∏–µ–º
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö > 5%

2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
   - –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Å–µ –±–∏–ª–µ—Ç—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –í–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - –ê—É–¥–∏—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

3. **–õ–∏–º–∏—Ç—ã:**
   - –ú–∞–∫—Å–∏–º—É–º 100 –±–∏–ª–µ—Ç–æ–≤ –∑–∞ —Ä–∞–∑ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
   - Rate limiting –¥–ª—è API endpoints
   - –õ–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
   - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø—Ä–∏–∑–æ–≤
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-02  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production

