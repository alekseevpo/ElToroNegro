# Bitcoin Price Bet - Ставки на цену биткоина

## Описание

Контракт для ставок на цену биткоина. Участники делают ставки на предполагаемую цену BTC в пятницу, старт приема ставок - понедельник.

## Как это работает

1. **Понедельник** - Старт приема ставок
2. **Понедельник-Четверг** - Участники делают ставки, указывая предполагаемую цену BTC
3. **Пятница** - Определение победителей на основе реальной цены BTC из Chainlink
4. **После определения** - Распределение призов между победителями

## Основные функции

### Для участников

#### `placeBet(uint256 _predictedPrice)`
Сделать ставку на цену биткоина.

**Параметры:**
- `_predictedPrice` - Предполагаемая цена BTC в USD (без десятичных знаков)
  - Например, для $50,000.00 укажите `50000`
  - Для $43,250.50 укажите `43251` (округление)

**Требования:**
- Ставки принимаются только в период понедельник-четверг
- Одна ставка на участника
- Точная сумма ставки (betAmount)

**Пример:**
```javascript
// Ставка на цену $52,500
await bitcoinBet.placeBet(52500, { value: ethers.parseEther("0.01") });
```

#### `getBet(address player)`
Получить информацию о ставке участника.

#### `getCurrentBTCPrice()`
Получить текущую цену BTC из Chainlink.

#### `getBetStatus()`
Получить общий статус ставки (закрыты ли ставки, определены ли победители, и т.д.)

### Для Owner

#### `closeBets()`
Закрыть прием ставок досрочно (если нужно).

#### `determineWinners()`
Определить победителей на основе цены BTC в пятницу.

**Как работает:**
1. Получает текущую цену BTC из Chainlink Price Feed
2. Находит участников, чьи ставки наиболее близки к реальной цене
3. Все участники с одинаковой минимальной разницей считаются победителями
4. Призы распределяются между победителями поровну

#### `distributePrizes()`
Распределить призы между победителями.

**Распределение:**
- Комиссия owner вычитается из призового фонда
- Остаток делится поровну между победителями
- Остаток (если есть) отдается первому победителю в списке

#### `pause() / unpause()`
Приостановить/возобновить работу контракта (emergency stop).

#### `setCommission(uint256 _ownerCommissionPercent)`
Изменить комиссию owner (максимум 10%).

#### `createNewBet(...)`
Создать новую ставку после завершения предыдущей.

## Chainlink Price Feed

Контракт использует Chainlink Price Feed для получения актуальной цены BTC/USD.

### Адреса для разных сетей

#### Sepolia Testnet
- BTC/USD: `0x1b44F3514812d835EB1BDB0acB33d3fA3351Ee43`

#### Ethereum Mainnet
- BTC/USD: `0xF4030086522a5bEEa4988F8cA5B36dbC97BeE88c`

**Важно:** Убедитесь, что используете правильный адрес для вашей сети!

## Формат цены

**Chainlink Price Feed:**
- Возвращает цену с 8 десятичными знаками
- Например, $50,000.00 = `5000000000` (5 миллиардов)

**В контракте:**
- Участники указывают цену без десятичных знаков
- Например, $50,000 = `50000`
- Контракт автоматически конвертирует цену Chainlink для сравнения

## Определение победителей

Победители определяются по принципу **минимальной разницы**:

1. Вычисляется реальная цена BTC в пятницу
2. Для каждой ставки вычисляется абсолютная разница с реальной ценой
3. Находятся все ставки с минимальной разницей
4. Все участники с минимальной разницей становятся победителями

**Пример:**
- Реальная цена BTC: $50,000
- Ставки: $49,950, $50,000, $50,050, $49,900, $50,100
- Победитель: $50,000 (разница = 0)
- Если никто не угадал точно, победители - те, кто ближе всего

## Временные параметры

При деплое контракта нужно указать:

- `betStartTime` - Время начала (понедельник)
- `betDuration` - Длительность приема ставок (обычно 4 дня = 345,600 секунд)
- `resultDelay` - Задержка до получения результата (обычно 1 день = 86,400 секунд)

**Рекомендации:**
- Используйте UTC время
- Убедитесь, что времена соответствуют началу/концу недели
- Для автоматизации можно создать скрипт, который вычисляет время следующего понедельника

## Безопасность

### Защита
- ✅ ReentrancyGuard - защита от повторного входа
- ✅ Pausable - возможность приостановки контракта
- ✅ Ownable - контроль доступа
- ✅ Проверка временных ограничений
- ✅ Проверка Chainlink Price Feed данных

### Важные моменты
- Цена из Chainlink проверяется на валидность (> 0)
- Один участник = одна ставка
- Ставки нельзя изменить после размещения
- Призы распределяются только после определения победителей

## Пример использования

### Создание ставки

```javascript
const BitcoinPriceBet = await ethers.getContractFactory("BitcoinPriceBet");
const bitcoinBet = await BitcoinPriceBet.deploy(
    btcPriceFeedAddress,  // Адрес Chainlink Price Feed
    ethers.parseEther("0.01"), // Сумма ставки
    betStartTime, // Время начала (понедельник)
    345600, // 4 дня (понедельник-четверг)
    86400,  // 1 день (до пятницы)
    200     // 2% комиссия
);
```

### Размещение ставки

```javascript
// Участник делает ставку на $52,500
await bitcoinBet.placeBet(52500, { 
    value: ethers.parseEther("0.01") 
});
```

### Определение победителей (в пятницу)

```javascript
// Owner определяет победителей
await bitcoinBet.determineWinners();
```

### Распределение призов

```javascript
// Распределить призы между победителями
await bitcoinBet.distributePrizes();
```

## События (Events)

- `BetPlaced(address indexed player, uint256 predictedPrice, uint256 timestamp)` - Ставка размещена
- `BetsClosed(uint256 timestamp)` - Ставки закрыты
- `ResultDetermined(int256 finalPrice, address[] winners, uint256 prizePool)` - Победители определены
- `PrizeDistributed(address indexed winner, uint256 amount)` - Приз выплачен
- `CommissionUpdated(uint256 oldPercent, uint256 newPercent)` - Комиссия изменена

## Ограничения

- Одна ставка на участника
- Ставки принимаются только в определенный период
- Нет возврата средств до определения победителей
- Комиссия owner вычитается из призового фонда

## Рекомендации для production

1. **Тестирование на testnet** - протестируйте весь цикл перед mainnet
2. **Мониторинг цены** - следите за ценой BTC и Chainlink feeds
3. **Автоматизация** - рассмотрите автоматическое определение победителей в пятницу
4. **Проверка адресов** - убедитесь в правильности адресов Chainlink для вашей сети
5. **Аудит** - проведите аудит контракта перед запуском

